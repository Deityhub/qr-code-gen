const fs = require('fs');
const path = require('path');

// Ranges of valid Double-Byte Shift JIS characters used in QR
// Range 1: 0x8140 - 0x9FFC
// Range 2: 0xE040 - 0xEBBF
const RANGES = [
    { start: 0x8140, end: 0x9FFC },
    { start: 0xE040, end: 0xEBBF }
];

console.log("Generating Shift JIS Map... this may take a moment.");

const map = {};
const decoder = new TextDecoder('shift-jis');

for (const range of RANGES) {
    for (let code = range.start; code <= range.end; code++) {
        const high = (code >> 8) & 0xFF;
        const low = code & 0xFF;

        // Skip invalid low bytes in Shift JIS (only 0x40-0x7E and 0x80-0xFC are valid)
        if (low < 0x40 || low === 0x7F || low > 0xFC) continue;

        const buffer = new Uint8Array([high, low]);
        try {
            const char = decoder.decode(buffer);
            // Some codes map to the replacement character ( / 65533) if undefined
            if (char.charCodeAt(0) !== 65533) {
                const unicode = char.charCodeAt(0);
                map[unicode] = code;
            }
        } catch (e) {
            // Ignore decoding errors
        }
    }
}

// Write to src/encoder/sjisMap.ts
const content = `// This file is auto-generated by scripts/build-jis-map.js
// It contains the full JIS X 0208 character mapping for QR Kanji mode.

export const FULL_SJIS_MAP: Record<number, number> = ${JSON.stringify(map, null, 0)};
`;

const outputPath = path.join(__dirname, './src/encoder/sjisMap.ts');
fs.writeFileSync(outputPath, content, 'utf8');

console.log(`Success! Map written to ${outputPath}`);
console.log(`Total mapped characters: ${Object.keys(map).length}`);